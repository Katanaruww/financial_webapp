<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —É—á—ë—Ç</title>
  <script>
    let user_id = 1;

    async function sendFormData(type) {
      const formData = new FormData(document.getElementById(`${type}-form`));
      const data = Object.fromEntries(formData.entries());

      const res = await fetch(`https://financial-webapp-bot.onrender.com/api/${type}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      alert(result.message);
      backToMenu();
      loadLatest();
    }

    async function loadLatest() {
      const res = await fetch(`https://financial-webapp-bot.onrender.com/api/report`);
      const data = await res.json();
      const latest = document.getElementById("latest-expenses");
      latest.innerHTML = "";
      data.latest_expenses.forEach(([title, amount]) => {
        const div = document.createElement("div");
        div.className = "text-sm text-gray-700";
        div.textContent = `${title} ‚Äî ${amount}‚ÇΩ`;
        latest.appendChild(div);
      });
    }

    async function loadView(type) {
      const res = await fetch(`https://financial-webapp-bot.onrender.com/api/report`);
      const data = await res.json();
      const table = document.getElementById("view-table");
      table.innerHTML = "";
      const rows = type === "income" ? data.incomes : data.expenses;

      if (rows.length === 0) {
        table.innerHTML = '<p class="text-center text-gray-500">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>';
        return;
      }

      rows.forEach((row) => {
        const tr = document.createElement("tr");
        const formatted = type === 'income'
          ? [row[0], `${row[1]}‚ÇΩ`, formatDate(row[2])]
          : [row[0], row[1], `${row[2]}‚ÇΩ`, row[3] ? "‚ö†Ô∏è" : "", formatDate(row[4])];

        formatted.forEach((val) => {
          const td = document.createElement("td");
          td.className = "border px-2 py-1 text-sm";
          td.textContent = val;
          tr.appendChild(td);
        });
        table.appendChild(tr);
      });
    }

    async function loadStats() {
      const res = await fetch(`https://financial-webapp-bot.onrender.com/api/report`);
      const data = await res.json();
      document.getElementById("stat-income").textContent = `${data.total_income}‚ÇΩ`;
      document.getElementById("stat-expense").textContent = `${data.total_expense}‚ÇΩ`;
      document.getElementById("stat-balance").textContent = `${data.balance}‚ÇΩ`;

      const categories = document.getElementById("stat-categories");
      categories.innerHTML = "";
      data.category_totals.forEach(([cat, sum]) => {
        const li = document.createElement("li");
        li.textContent = `${cat} ‚Äî ${sum}‚ÇΩ`;
        categories.appendChild(li);
      });
    }

    async function clearAllData() {
      const confirmed = confirm("–¢—ã —Ç–æ—á–Ω–æ —Ö–æ—á–µ—à—å —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏?");
      if (!confirmed) return;
      const res = await fetch(`https://financial-webapp-bot.onrender.com/api/clear`, {
        method: "POST"
      });
      const result = await res.json();
      alert(result.message);
      loadLatest();
    }

    function toggleForm(type) {
      document.getElementById('expense-form').classList.add('hidden');
      document.getElementById('income-form').classList.add('hidden');
      document.getElementById(`${type}-form`).classList.remove('hidden');
    }

    function showAdd() {
      hideAll();
      document.getElementById('add-section').classList.remove('hidden');
    }

    function showView() {
      hideAll();
      document.getElementById('view-section').classList.remove('hidden');
    }

    function showStats() {
      hideAll();
      document.getElementById('stats-section').classList.remove('hidden');
      loadStats();
    }

    function backToMenu() {
      hideAll();
      document.getElementById('main-menu').classList.remove('hidden');
      loadLatest();
    }

    function hideAll() {
      document.getElementById('main-menu').classList.add('hidden');
      document.getElementById('add-section').classList.add('hidden');
      document.getElementById('view-section').classList.add('hidden');
      document.getElementById('stats-section').classList.add('hidden');
    }

    function formatDate(iso) {
      const d = new Date(iso);
      return d.toLocaleDateString("ru-RU");
    }

    window.onload = loadLatest;
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-md mx-auto bg-white shadow-xl rounded-xl p-6" id="main-menu">
    <h1 class="text-2xl font-bold text-center mb-4">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —É—á—ë—Ç</h1>
    <div class="flex items-center justify-between gap-2 mb-4">
      <div class="flex-grow">
        <button onclick="showAdd()" class="bg-blue-500 text-white w-full py-2 rounded">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
      </div>
      <div class="flex flex-col gap-1">
        <button onclick="showStats()" class="bg-gray-400 text-white px-3 py-2 rounded text-sm">üìä</button>
        <button onclick="clearAllData()" class="bg-red-500 text-white px-3 py-2 rounded text-sm">üóë</button>
      </div>
    </div>
    <div class="bg-gray-100 rounded p-2">
      <p class="text-sm font-semibold mb-1">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞—Ç—ã:</p>
      <div id="latest-expenses" class="space-y-1"></div>
    </div>
  </div>

  <!-- –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
</body>
</html>
